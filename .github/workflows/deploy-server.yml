# ================================================================
# GitHub Actions - Deploy FRP Server to VPS
# ================================================================
name: Deploy FRP Server

on:
  push:
    branches: [main, master]
    paths:
      - 'camaras/server-completo-frp/**'
      - '.github/workflows/deploy-server.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  # ============================================================
  # Job: Build, Test & Deploy
  # ============================================================
  deploy:
    name: Build & Deploy FRP Server
    runs-on: self-hosted
    timeout-minutes: 20
    
    steps:
    - name: üë§ Mostrar usuario del runner
      run: whoami

    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4

    - name: üîç Verificar t√∫nel Cloudflare
      run: |
        echo "üîç Verificando t√∫nel Cloudflare..."
        
        if pgrep -f "cloudflared tunnel" > /dev/null; then
          echo "‚úÖ Proceso cloudflared est√° ejecut√°ndose"
        else
          echo "‚ö†Ô∏è No se encontr√≥ proceso cloudflared activo"
        fi
        
        echo "üìä Procesos cloudflared:"
        ps aux | grep cloudflared || true

    - name: üü¢ Verificar Node.js
      run: |
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"

    - name: üì¶ Instalar dependencias y validar
      run: |
        echo "üì¶ Instalando dependencias..."
        cd camaras/server-completo-frp
        npm ci
        
        echo "üîç Verificando sintaxis del servidor..."
        node --check server-completo-frp.mjs
        
        echo "‚úÖ Tests (si existen)..."
        npm test --if-present || true

    - name: ‚èπÔ∏è Parar servicios existentes
      run: |
        echo "‚èπÔ∏è Parando contenedores existentes..."
        cd camaras/server-completo-frp
        docker compose down 2>/dev/null || true
        
        echo "üßπ Limpiando Docker..."
        docker system prune -af --volumes
        docker builder prune -af
        docker image prune -af
        
        echo "üîÑ Reiniciando Docker daemon..."
        sudo systemctl restart docker 2>/dev/null || echo "No se puede reiniciar Docker daemon"
        sleep 5

    - name: üìÅ Crear directorios necesarios
      run: |
        echo "üìÅ Creando directorios necesarios..."
        cd camaras/server-completo-frp
        mkdir -p streams videos logs
        chmod 777 streams videos logs
        echo "‚úÖ Directorios creados"

    - name: üèóÔ∏è Construir y desplegar aplicaci√≥n
      run: |
        echo "üèóÔ∏è Iniciando construcci√≥n..."
        cd camaras/server-completo-frp
        
        echo "üî® Construyendo aplicaci√≥n..."
        for attempt in 1 2 3; do
          echo "Intento $attempt de construcci√≥n..."
          if docker compose build --no-cache --pull; then
            echo "‚úÖ Construcci√≥n exitosa"
            break
          else
            echo "‚ùå Fall√≥ intento $attempt"
            if [ $attempt -eq 3 ]; then
              echo "üí• Fall√≥ despu√©s de 3 intentos"
              exit 1
            fi
            sleep 10
          fi
        done

    - name: üöÄ Levantar servicios
      run: |
        echo "üöÄ Levantando servicios..."
        cd camaras/server-completo-frp
        docker compose up -d
        
        echo "‚è≥ Esperando que los servicios est√©n listos..."
        sleep 15

    - name: üè• Verificar salud de la aplicaci√≥n
      run: |
        echo "üè• Verificando salud de la aplicaci√≥n..."
        
        echo "üìä Estado de contenedores:"
        cd camaras/server-completo-frp
        docker compose ps
        
        echo "üîç Logs del servidor FRP:"
        docker compose logs --tail 50 frp-server || true
        
        echo "üåê Probando endpoint local (puerto 3100)..."
        for i in {1..10}; do
          if curl -s -f http://localhost:3100/api/health > /dev/null; then
            echo "‚úÖ Aplicaci√≥n responde correctamente en puerto 3100"
            curl -s http://localhost:3100/api/health | head -20
            exit 0
          fi
          echo "‚è≥ Intento $i/10 - Esperando..."
          sleep 5
        done
        
        echo "‚ö†Ô∏è La aplicaci√≥n no responde en localhost:3100"

    - name: üìä Resultado del despliegue
      if: always()
      run: |
        echo "üìä RESUMEN DEL DESPLIEGUE"
        echo "========================"
        echo "Repositorio: ${{ github.repository }}"
        echo "Rama: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "üê≥ Estado de Docker:"
        cd camaras/server-completo-frp
        docker compose ps
        echo ""
        echo "üìù √öltimos logs del servidor:"
        docker compose logs --tail 30 frp-server || true
        echo ""
        echo "‚úÖ Deployment completado"

    - name: üîß Fix workspace permissions (evitar EACCES)
      if: always()
      run: |
        echo "üîß Ajustando permisos del workspace..."
        cd camaras/server-completo-frp
        if [ -d "logs" ]; then
          chown -R $USER logs || true
          chmod -R u+rwx logs || true
        fi
        chown -R $USER:$USER . || true
        find . -type f -exec chmod u+w {} +
