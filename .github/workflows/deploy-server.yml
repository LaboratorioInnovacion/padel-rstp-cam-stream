# ================================================================
# GitHub Actions - Deploy FRP Server to VPS
# ================================================================
name: Deploy FRP Server

on:
  push:
    branches: [main, master]
    paths:
      - 'camaras/server-completo-frp/**'
      - '.github/workflows/deploy-server.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  # ============================================================
  # Job: Build, Test & Deploy
  # ============================================================
  deploy:
    name: Build & Deploy FRP Server
    runs-on: self-hosted
    timeout-minutes: 20
    
    steps:
    - name: ðŸ‘¤ Mostrar usuario del runner
      run: whoami

    - name: ðŸ§¹ Limpiar directorios problemÃ¡ticos
      run: |
        echo "ðŸ§¹ Limpiando directorios con permisos de Docker..."
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/streams/ || true
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/videos/ || true
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/logs/ || true
        echo "âœ… Limpieza completada"

    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ” Verificar tÃºnel Cloudflare
      run: |
        echo "ðŸ” Verificando tÃºnel Cloudflare..."
        
        if pgrep -f "cloudflared tunnel" > /dev/null; then
          echo "âœ… Proceso cloudflared estÃ¡ ejecutÃ¡ndose"
        else
          echo "âš ï¸ No se encontrÃ³ proceso cloudflared activo"
        fi
        
        echo "ðŸ“Š Procesos cloudflared:"
        ps aux | grep cloudflared || true

    - name: ðŸŸ¢ Verificar Node.js
      run: |
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "User ID: $(id -u):$(id -g)"

    - name: ðŸ“¦ Instalar dependencias y validar
      run: |
        echo "ðŸ“¦ Instalando dependencias..."
        cd camaras/server-completo-frp
        npm ci
        
        echo "ðŸ” Verificando sintaxis del servidor..."
        node --check server-completo-frp.mjs
        
        echo "âœ… Tests (si existen)..."
        npm test --if-present || true

    - name: â¹ï¸ Parar servicios existentes
      run: |
        echo "â¹ï¸ Parando contenedores existentes..."
        cd camaras/server-completo-frp
        docker compose down 2>/dev/null || true
        
        echo "ðŸ§¹ Limpiando Docker..."
        docker system prune -af --volumes
        docker builder prune -af
        docker image prune -af
        
        echo "ðŸ”„ Reiniciando Docker daemon..."
        sudo systemctl restart docker 2>/dev/null || echo "No se puede reiniciar Docker daemon"
        sleep 5

    - name: ðŸ“ Crear directorios necesarios
      run: |
        echo "ðŸ“ Creando directorios necesarios..."
        cd camaras/server-completo-frp
        mkdir -p streams videos logs
        chmod 777 streams videos logs
        echo "âœ… Directorios creados"

    - name: ðŸ—ï¸ Construir y desplegar aplicaciÃ³n
      run: |
        echo "ðŸ—ï¸ Iniciando construcciÃ³n..."
        cd camaras/server-completo-frp
        
        echo "ðŸ”¨ Construyendo aplicaciÃ³n..."
        for attempt in 1 2 3; do
          echo "Intento $attempt de construcciÃ³n..."
          if docker compose build --no-cache --pull; then
            echo "âœ… ConstrucciÃ³n exitosa"
            break
          else
            echo "âŒ FallÃ³ intento $attempt"
            if [ $attempt -eq 3 ]; then
              echo "ðŸ’¥ FallÃ³ despuÃ©s de 3 intentos"
              exit 1
            fi
            sleep 10
          fi
        done

    - name: ðŸš€ Levantar servicios
      run: |
        echo "ðŸš€ Levantando servicios..."
        cd camaras/server-completo-frp
        docker compose up -d
        
        echo "â³ Esperando que los servicios estÃ©n listos..."
        sleep 15

    - name: ðŸ¥ Verificar salud de la aplicaciÃ³n
      run: |
        echo "ðŸ¥ Verificando salud de la aplicaciÃ³n..."
        
        echo "ðŸ“Š Estado de contenedores:"
        cd camaras/server-completo-frp
        docker compose ps
        
        echo "ðŸ” Logs del servidor FRP:"
        docker compose logs --tail 50 frp-server || true
        
        echo "ðŸŒ Probando endpoint local (puerto 3100)..."
        for i in {1..10}; do
          if curl -s -f http://localhost:3100/api/health > /dev/null; then
            echo "âœ… AplicaciÃ³n responde correctamente en puerto 3100"
            curl -s http://localhost:3100/api/health | head -20
            exit 0
          fi
          echo "â³ Intento $i/10 - Esperando..."
          sleep 5
        done
        
        echo "âš ï¸ La aplicaciÃ³n no responde en localhost:3100"

    - name: ðŸ“Š Resultado del despliegue
      if: always()
      run: |
        echo "ðŸ“Š RESUMEN DEL DESPLIEGUE"
        echo "========================"
        echo "Repositorio: ${{ github.repository }}"
        echo "Rama: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "ðŸ³ Estado de Docker:"
        cd camaras/server-completo-frp
        docker compose ps
        echo ""
        echo "ðŸ“ Ãšltimos logs del servidor:"
        docker compose logs --tail 30 frp-server || true
        echo ""
        echo "âœ… Deployment completado"

    - name: ðŸ”§ Fix workspace permissions (evitar EACCES)
      if: always()
      run: |
        echo "ðŸ”§ Ajustando permisos del workspace..."
        cd camaras/server-completo-frp
        
        # Solo intentar cambiar permisos de archivos propios
        find . -user $USER -type f -exec chmod u+w {} + 2>/dev/null || true
        
        echo "âœ… Permisos ajustados"
