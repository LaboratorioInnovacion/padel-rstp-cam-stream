# ================================================================
# GitHub Actions - Deploy Cloudflared Server to VPS
# ================================================================
name: Deploy Cloudflared Server

on:
  push:
    branches: [main, master]
    paths:
      - 'camaras/server-completo-frp/**'
      - '.github/workflows/deploy-server.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  # ============================================================
  # Job: Build, Test & Deploy
  # ============================================================
  deploy:
    name: Build & Deploy Cloudflared Server
    runs-on: self-hosted
    timeout-minutes: 20
    
    steps:
    - name: ðŸ‘¤ Mostrar usuario del runner
      run: whoami

    - name: ðŸ§¹ Limpiar directorios problemÃ¡ticos
      run: |
        echo "ðŸ§¹ Limpiando directorios con permisos de Docker..."
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/streams/ || true
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/videos/ || true
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/logs/ || true
        echo "âœ… Limpieza completada"

    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ” Verificar tÃºnel Cloudflare
      run: |
        echo "ðŸ” Verificando tÃºnel Cloudflare..."
        
        if pgrep -f "cloudflared tunnel" > /dev/null; then
          echo "âœ… Proceso cloudflared estÃ¡ ejecutÃ¡ndose"
        else
          echo "âš ï¸ No se encontrÃ³ proceso cloudflared activo"
        fi
        
        echo "ðŸ“Š Procesos cloudflared:"
        ps aux | grep cloudflared || true

    - name: ðŸŸ¢ Verificar Node.js
      run: |
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "User ID: $(id -u):$(id -g)"

    - name: ðŸ“¦ Instalar dependencias y validar
      run: |
        echo "ðŸ“¦ Instalando dependencias..."
        cd camaras/server-completo-frp
        npm ci
        
        echo "ðŸ” Verificando sintaxis del servidor Cloudflared..."
        node --check server-cloudflared.mjs
        
        echo "âœ… Validando archivo existe..."
        if [ ! -f server-cloudflared.mjs ]; then
          echo "âŒ server-cloudflared.mjs no encontrado"
          exit 1
        fi
        
        echo "âœ… Tests (si existen)..."
        npm test --if-present || true

    - name: â¹ï¸ Parar servicios existentes
      run: |
        echo "â¹ï¸ Parando contenedores existentes..."
        cd camaras/server-completo-frp
        docker compose down 2>/dev/null || true
        
        echo "ðŸ§¹ Limpiando Docker..."
        docker system prune -af --volumes
        docker builder prune -af
        docker image prune -af
        
        echo "ðŸ”„ Reiniciando Docker daemon..."
        sudo systemctl restart docker 2>/dev/null || echo "No se puede reiniciar Docker daemon"
        sleep 5

    - name: ðŸ“ Crear directorios necesarios
      run: |
        echo "ðŸ“ Creando directorios necesarios..."
        cd camaras/server-completo-frp
        mkdir -p streams videos logs
        chmod 777 streams videos logs
        echo "âœ… Directorios creados"

    - name: ðŸ—ï¸ Construir imagen Docker
      run: |
        echo "ðŸ—ï¸ Construyendo imagen del servidor Cloudflared..."
        cd camaras/server-completo-frp
        
        echo "ðŸ“ Creando archivo cameras-cloudflared.json si no existe..."
        if [ ! -f cameras-cloudflared.json ]; then
          echo '[]' > cameras-cloudflared.json
        fi
        
        echo "ðŸ“ Creando Dockerfile para Cloudflared..."
        cat > Dockerfile.cloudflared << 'EOF'
        FROM node:18-alpine
        
        WORKDIR /app
        
        COPY package*.json ./
        RUN npm ci --only=production
        
        COPY server-cloudflared.mjs ./
        COPY cameras-cloudflared.json ./
        
        EXPOSE 3100
        
        CMD ["node", "server-cloudflared.mjs"]
        EOF
        
        echo "ðŸ”¨ Construyendo imagen..."
        docker build -t camaras-server-cloudflared:latest -f Dockerfile.cloudflared .
        echo "âœ… ConstrucciÃ³n exitosa"

    - name: ðŸš€ Levantar servidor Cloudflared
      run: |
        echo "ðŸš€ Levantando servidor Cloudflared..."
        cd camaras/server-completo-frp
        
        echo "ðŸ“ Verificando archivo de configuraciÃ³n..."
        if [ ! -f cameras-cloudflared.json ]; then
          echo '[]' > cameras-cloudflared.json
        fi
        
        docker stop camaras-server-cloudflared 2>/dev/null || true
        docker rm camaras-server-cloudflared 2>/dev/null || true
        
        docker run -d \
          --name camaras-server-cloudflared \
          --restart unless-stopped \
          -p 3100:3100 \
          -v "$(pwd)/cameras-cloudflared.json:/app/cameras-cloudflared.json" \
          camaras-server-cloudflared:latest
        
        echo "â³ Esperando que el servidor estÃ© listo..."
        sleep 15

    - name: ðŸ¥ Verificar salud del servidor Cloudflared
      run: |
        echo "ðŸ¥ Verificando salud del servidor..."
        
        echo "ðŸ“Š Estado del contenedor:"
        docker ps | grep camaras-server-cloudflared || true
        
        echo "ðŸ” Logs del servidor:"
        docker logs camaras-server-cloudflared --tail 50 || true
        
        echo "ðŸŒ Probando endpoint /api/health (puerto 3100)..."
        for i in {1..10}; do
          if curl -s -f http://localhost:3100/api/health > /dev/null; then
            echo "âœ… Servidor Cloudflared responde correctamente"
            echo "ðŸ“Š Health check:"
            curl -s http://localhost:3100/api/health | jq . 2>/dev/null || curl -s http://localhost:3100/api/health
            echo ""
            echo "ðŸŽ¥ Streams registrados:"
            curl -s http://localhost:3100/api/streams | jq . 2>/dev/null || curl -s http://localhost:3100/api/streams
            exit 0
          fi
          echo "â³ Intento $i/10 - Esperando..."
          sleep 5
        done
        
        echo "âš ï¸ El servidor no responde en localhost:3100"
        docker logs camaras-server-cloudflared --tail 100

    - name: ðŸ“Š Resultado del despliegue
      if: always()
      run: |
        echo "ðŸ“Š RESUMEN DEL DESPLIEGUE CLOUDFLARED"
        echo "====================================="
        echo "Repositorio: ${{ github.repository }}"
        echo "Rama: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "ðŸ³ Contenedor activo:"
        docker ps | grep camaras-server-cloudflared || echo "No encontrado"
        echo ""
        echo "ðŸ“ Ãšltimos logs:"
        docker logs camaras-server-cloudflared --tail 30 || true
        echo ""
        echo "ðŸŽ¥ Streams disponibles:"
        curl -s http://localhost:3100/api/streams | jq '.count,.streams[].name' 2>/dev/null || echo "No disponible"
        echo ""
        echo "âœ… Deployment completado"

    - name: ðŸ”§ Fix workspace permissions (evitar EACCES)
      if: always()
      run: |
        echo "ðŸ”§ Ajustando permisos del workspace..."
        cd camaras/server-completo-frp
        
        # Solo intentar cambiar permisos de archivos propios
        find . -user $USER -type f -exec chmod u+w {} + 2>/dev/null || true
        
        echo "âœ… Permisos ajustados"
