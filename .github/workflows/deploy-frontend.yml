# ================================================================
# GitHub Actions - Deploy Frontend to VPS
# ================================================================
name: Deploy Frontend

on:
  push:
    branches: [main, master]
    paths:
      - 'camaras/front/**'
      - '.github/workflows/deploy-frontend.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  # ============================================================
  # Job: Build, Test & Deploy Frontend
  # ============================================================
  deploy:
    name: Build & Deploy Frontend
    runs-on: self-hosted
    timeout-minutes: 15
    
    steps:
    - name: ğŸ‘¤ Mostrar usuario del runner
      run: whoami

    - name: ğŸ§¹ Limpiar directorios problemÃ¡ticos
      run: |
        echo "ğŸ§¹ Limpiando directorios con permisos de Docker..."
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/streams/ || true
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/videos/ || true
        sudo rm -rf ${{ github.workspace }}/camaras/server-completo-frp/logs/ || true
        echo "âœ… Limpieza completada"

    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Verificar Node.js
      run: |
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"

    - name: ğŸ“¦ Instalar dependencias
      run: |
        echo "ğŸ“¦ Instalando dependencias del frontend..."
        cd camaras/front
        npm ci

    - name: ğŸ” Verificar sintaxis
      run: |
        echo "ğŸ” Verificando sintaxis TypeScript..."
        cd camaras/front
        npx tsc --noEmit || echo "âš ï¸ TypeScript check encontrÃ³ warnings (no bloquea deploy)"

    - name: â¹ï¸ Parar contenedores existentes
      run: |
        echo "â¹ï¸ Parando contenedores del frontend..."
        cd camaras/front
        docker compose down 2>/dev/null || docker stop camaras-frontend 2>/dev/null || true
        docker rm camaras-frontend 2>/dev/null || true

    - name: ğŸ—ï¸ Construir aplicaciÃ³n optimizada
      run: |
        echo "ğŸ—ï¸ Construyendo frontend con optimizaciones..."
        echo "  - HLS.js con error recovery mejorado"
        echo "  - Vite code splitting (vendor/hls/ui)"
        echo "  - Terser minification + drop_console"
        echo "  - nginx gzip compression + caching"
        cd camaras/front
        
        for attempt in 1 2 3; do
          echo "Intento $attempt de construcciÃ³n..."
          if docker build -t camaras-frontend:latest .; then
            echo "âœ… ConstrucciÃ³n exitosa"
            break
          else
            echo "âŒ FallÃ³ intento $attempt"
            if [ $attempt -eq 3 ]; then
              echo "ğŸ’¥ FallÃ³ despuÃ©s de 3 intentos"
              exit 1
            fi
            sleep 5
          fi
        done

    - name: ğŸš€ Levantar contenedor
      run: |
        echo "ğŸš€ Levantando contenedor del frontend..."
        cd camaras/front
        docker run -d \
          --name camaras-frontend \
          --restart unless-stopped \
          -p 3110:80 \
          camaras-frontend:latest
        
        echo "â³ Esperando que el frontend estÃ© listo..."
        sleep 10

    - name: ğŸ¥ Verificar salud del frontend
      run: |
        echo "ğŸ¥ Verificando que el frontend responde..."
        
        echo "ğŸ“Š Estado del contenedor:"
        docker ps | grep camaras-frontend || true
        
        echo "ğŸŒ Probando endpoint (puerto 3110)..."
        for i in {1..10}; do
          if curl -s -f http://localhost:3110 > /dev/null; then
            echo "âœ… Frontend responde correctamente en puerto 3110"
            exit 0
          fi
          echo "â³ Intento $i/10 - Esperando..."
          sleep 3
        done
        
        echo "âš ï¸ El frontend no responde en localhost:3110"
        docker logs camaras-frontend --tail 20

    - name: ğŸ“Š Resultado del despliegue
      if: always()
      run: |
        echo "ğŸ“Š RESUMEN DEL DESPLIEGUE FRONTEND"
        echo "=================================="
        echo "Repositorio: ${{ github.repository }}"
        echo "Rama: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "ğŸ³ Estado del contenedor:"
        docker ps | grep camaras-frontend || true
        echo ""
        echo "ğŸ“ Ãšltimos logs:"
        docker logs camaras-frontend --tail 30 || true
        echo ""
        echo "âœ… Deployment completado"

    - name: ğŸ”§ Limpiar imÃ¡genes antiguas
      if: always()
      run: |
        echo "ğŸ§¹ Limpiando imÃ¡genes Docker antiguas..."
        docker image prune -f || true
